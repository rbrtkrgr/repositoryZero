name: Signed Commit Test

on:
  workflow_dispatch:

jobs:
  add-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: "main"
      - name: Make Change(s)
        run: |
          echo "testing" >> newfile.txt
          
      - name: Detect changed files
        id: changes
        run: |
          git config --global user.email "rbrtkrgr@icloud.com"
          git config --global user.name "rbrtkrgr"
          git add .

          CHANGED_FILES=$(git diff --staged --name-only)
          
          echo "Changed files: $CHANGED_FILES"
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
      - name: Prepare CreateCommitOnBranch payload
        id: prepare-payload
        run: |
          FILES=$(echo "${{ steps.changes.outputs.files }}" | tr " " "\n")
          ADDITIONS=""
          for FILE in $FILES; do
            CONTENT=$(cat "$FILE" | base64 | tr -d '\n')
            ADDITIONS+=$(jq -n --compact-output --arg path "$FILE" --arg contents "$CONTENT" '{"path":$path,"contents":$contents}')
            ADDITIONS+=","
          done
          ADDITIONS=${ADDITIONS%,}
          echo "additions=[$ADDITIONS]" >> $GITHUB_OUTPUT

      - name: Get the latest commit SHA
        id: get-sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        
      - name: Add File and Commit
        run: |
          echo "Additions: ${{ steps.prepare-payload.outputs.additions }}"
          echo "SHA: ${{ steps.get-sha.outputs.sha }}"
          echo "Repository: ${{github.repository}}"
          echo "Branch: ${{github.ref_name}}"

          # GraphQL query for creating a commit
          QUERY='
          mutation CreateCommit($input: CreateCommitOnBranchInput!) {
            createCommitOnBranch(input: $input) {
              commit {
                oid
                message
                url
              }
            }
          }'

          INPUT=$(jq -n \
            --arg repo "${{github.repository}}" \
            --arg branch "${{github.ref_name}}" \
            --arg message "Adding newfile.txt" \
            --arg sha "${{ steps.get-sha.outputs.sha }}" \
            --argjson additions '${{ steps.prepare-payload.outputs.additions }}' \
            '{
              "branch": {
                "repositoryNameWithOwner": $repo,
                "branchName": $branch
              },
              "message": {
                "headline": $message
              },
              "expectedHeadOid": $sha,
              "fileChanges": {
                "additions": $additions
              }
            }')

          export GH_TOKEN={{ secrets.PAT }}
          # Calling the GitHub GraphQL API
          gh api graphql -f query="$QUERY" -f input="$INPUT"
